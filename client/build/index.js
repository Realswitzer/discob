(()=>{var Y=Object.create;var H=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var X=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ee=(e,t,s,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of _(t))!W.call(e,r)&&r!==s&&H(e,r,{get:()=>t[r],enumerable:!(o=Z(t,r))||o.enumerable});return e};var te=(e,t,s)=>(s=e!=null?Y(q(e)):{},ee(t||!e||!e.__esModule?H(s,"default",{value:e,enumerable:!0}):s,e));var U=X((ae,R)=>{R.exports=io});var i=$("#messages"),S=$("#reply-label"),se=$("#close-reply"),a=$("#message-input");var I=/[^a-zA-Z0-9_-]+/g,N=/^[\w\-\.]+@([\w-]+\.)+[\w-]{2,}$/;var z=te(U()),l=(0,z.io)();var h=e=>{let t=`
      <span class="break-words text-[18px] text-text whitespace-pre-line">${e.text}</span>`,s=!e.chained||e.reply?`
      <div class="flex">
        <span class="username text-[20px]" style="color: ${e.sender.color}">${e.sender.username}</span>
        <span
            class="ml-2 text-[12px] text-subtext-0 justify-center items-center flex"
            >${A(e.timestamp)}</span
        >
      </div>`:"";return`<div class="message flex flex-col py-1 pl-4 hover:bg-base">
        `+(e.reply?`
      <div class="reply-container">
        <span class="reply-username text" style="color: ${e.reply.color}">${e.reply.username}</span>
          <div class="reply-message-container">
            <span class="reply-message text">${e.reply.text}</span>
          </div>
      </div>`:"")+s+t+"</div>"};var c=class{text;sender;timestamp;reply;chained;token;constructor(){this.text=null,this.sender={username:null,color:null},this.timestamp=new Date,this.reply=null,this.chained=!1,this.token=null}prepend(){let t=$(".username").first().text();return this.sender.username==t&&$(".username").first().parent().remove(),$(h(this)).data("message-info",this).insertBefore($(".message").first()),this}append(){let t=$(".username").last().text();return this.sender.username==t&&(this.chained=!0),$(h(this)).data("message-info",this).appendTo("#messages"),C(),this}setMessage(t){return this.text=d(t),this}setSender(t,s){return this.sender.username=d(t),this.sender.color=d(s),this}setTimestamp(t){return this.timestamp=t,this}setReply(t,s,o){return this.reply={username:s,color:o,text:t},this}setToken(t){return this.token=t,this}sendMessage(){return P(),l.emit("message",this),this}};function d(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}function g(){let e=new c().setMessage(a.val()).setSender(localStorage.getItem("username"),"white").setToken(localStorage.getItem("token"));e.text.trim().length!==0&&(a.val(""),u(),e.sendMessage().append())}function C(){i.animate({scrollTop:i[0].scrollHeight},0)}function P(){S.addClass("hidden").removeClass("flex"),a.removeClass("stacked")}function u(){a[0].style.height="0px",a[0].style.height=a[0].scrollHeight+"px"}function A(e){let t=e.toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}),s=new Date,o=new Date;switch(o.setDate(o.getDate()-1),e.toDateString()){case s.toDateString():return`Today at ${t}`;case o.toDateString():return`Yesterday at ${t}`;default:return`${e.toLocaleDateString()} ${t}`}}async function L(e,t,s){return await $.ajax({url:`/messages/${e}/${s}/${t}`,type:"GET"})}async function j(e,t,s){(await L(e,t,s)).reverse().forEach(r=>{let m=new Date(Number(r.MessageDate));new c().setMessage(r.MessageText).setSender(r.Username,r.UserColor).setTimestamp(m).append()})}async function B(e,t,s){let o=await L(e,t,s);return o.forEach(r=>{let m=new Date(Number(r.MessageDate));new c().setMessage(r.MessageText).setSender(r.Username,r.UserColor).setTimestamp(m).prepend()}),o}function K(e){let{username:t,password:s,confirmPassword:o,email:r}=e;return!t||!s||!o||!r?[!1,"Please enter all information"]:I.test(t)?[!1,"Invalid username"]:N.test(r)?o!=s?[!1,"Passwords do not match"]:[!0,""]:[!1,"Invalid email"]}function O(e){let{username:t,password:s}=e;return!t||!s?[!1,"Please enter all information"]:[!0,""]}function y(){a.trigger("focus")}function w(e){if(!(e.altKey||e.ctrlKey)){if(e.key==="Escape"){a.trigger("blur");return}a.trigger("focus")}}function v(e){switch(e.key){case"Enter":if(e.shiftKey)return;e.preventDefault(),g();break;default:break}}function D(){localStorage.getItem("token")&&(async()=>await j("public",50,0))()}var Q;function M(){clearTimeout(Q),Q=setTimeout(()=>{u()},50)}var V=e=>{let t=e.type==="Notice"?{border:"border-light-blue",bg:"bg-blue",hover:"hover:bg-dark-blue"}:{border:"border-maroon",bg:"bg-red",hover:"hover:bg-dark-red"};return`<div
        class="notification m-2 h-auto w-64 rounded-md border-2 ${t.border} ${t.bg} cursor-pointer ${t.hover} transition-all"
    >
        <div class="m-2 flex flex-col">
            <div class="flex space-x-1 align-middle">
                <svg
                    class="w-4"
                    viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        class="fill-white"
                        fill-rule="evenodd"
                        d="M10 3a7 7 0 100 14 7 7 0 000-14zm-9 7a9 9 0 1118 0 9 9 0 01-18 0zm8-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm.01 8a1 1 0 102 0V9a1 1 0 10-2 0v5z"
                    />
                </svg>
                <span class="font-monospace text-[14px] text-white"
                    >${e.type}</span
                >
            </div>
            <span class="font-monospace text-[14px] text-white"
                >${e.message}</span
            >
        </div>
    </div>`};var n=class{message;type;constructor(){this.message="An error has occured",this.type=null}setMessage(t){return this.message=t,this}setType(t){return this.type=t,this}append(){let t=$(V(this)).css({opacity:0}).appendTo("#notifications").animate({opacity:1},300,"linear").on("click",function(){$(this).animate({opacity:0},300,"linear",function(){$(this).remove()})});return setTimeout(()=>{t.animate({opacity:0},300,"linear",function(){$(this).remove()})},5e3),this}};function b(e){e.preventDefault();let t={};$(this).serializeArray().map(r=>{t[r.name]=r.value});let[s,o]=K(t);s?$.ajax({url:"/register",method:"POST",processData:!1,data:JSON.stringify(t),contentType:"application/json"}).then(r=>{r.error?new n().setMessage(r.error).setType("Error").append():r.email&&(localStorage.setItem("email",r.email),window.location.href=window.location.origin+"/verification")}):new n().setMessage(o).setType("Error").append()}function T(e){e.preventDefault();let t=$("input[name=code]").val();if(t.trim()===""){new n().setMessage("Please enter a code").setType("Error").append();return}let s=localStorage.getItem("email");if(!s){new n().setType("Error").append();return}$.ajax({url:"/verify",method:"POST",data:JSON.stringify({email:s,code:t}),processData:!1,contentType:"application/json"}).then(o=>{if(o.error)new n().setMessage(o.error).setType("Error").append();else if(o.success){new n().setMessage(o.success).setType("Notice").append();let{token:r,username:m}=o.userData;console.log(r,m),localStorage.removeItem("email"),localStorage.setItem("token",r),localStorage.setItem("username",m),setTimeout(()=>{window.location.href=window.location.origin},1500)}})}function k(e){e.preventDefault();let t={};$(this).serializeArray().map(r=>{t[r.name]=r.value});let[s,o]=O(t);s?$.ajax({url:"/login",method:"POST",processData:!1,data:JSON.stringify(t),contentType:"application/json"}).then(r=>{if(r.error)new n().setMessage(r.error).setType("Error").append();else if(r.userData){let{username:m,token:G}=r.userData;localStorage.setItem("username",m),localStorage.setItem("token",G),window.location.href=window.location.origin}}):new n().setMessage(o).setType("Error").append()}var F=50,f=null;function E(e){f||(console.log("scroll"),f=setTimeout(()=>{if(clearTimeout(f),f=null,this.scrollTop<600){let t=i[0].scrollHeight,s=i.scrollTop();B("public",50,F).then(o=>{let r=i[0].scrollHeight;i.scrollTop(r-t+s),F+=o.length})}},250))}switch(window.location.pathname){case"/":$(window).on("load",D).on("resize",M),$(document).on("keydown",w),a.on("keydown",v).on("mouseover",y).on("input",u),$("#send-button").on("click",g),i.on("scroll",E);break;case"/account":$("#register-form").on("submit",b),$("#login-form").on("submit",k);break;case"/verification":$("#verification-form").on("submit",T);break;default:break}l.on("message",e=>{let t=new Date(e.timestamp);new c().setSender(e.sender.username,e.sender.color).setMessage(e.text).setTimestamp(t).append()});l.on("error",e=>{new n().setType("Error").setMessage(e).append()});l.on("disconnect",()=>{new n().setMessage("Socket has disconnected").setType("Error").append()});l.on("reconnect",()=>{new n().setType("Error").setMessage("test").append()});})();
